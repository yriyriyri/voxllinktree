// pages/_app.tsx
import "@/styles/globals.css";
import type { AppProps, AppContext } from "next/app";
import App from "next/app";
import React, { useEffect, useState } from "react";
import ThreeNodeSystem from "../components/ThreeNodeSystem/ThreeNodeSystem";
import ThreeNodeSystemMobile from "../components/ThreeNodeSystemMobile/ThreeNodeSystemMobile";
import { useRouter } from "next/router";
import { SpeedInsights } from "@vercel/speed-insights/next";

interface ArticleData {
  title: string;
  date: string;
  author: string;
  slug: string;
}

interface MyAppProps extends AppProps {
  articlesData: ArticleData[];
}

export default function MyApp({ Component, pageProps, articlesData }: MyAppProps) {
  const [isMobile, setIsMobile] = useState<boolean | null>(null);
  const router = useRouter();

  useEffect(() => {
    if (typeof window !== "undefined") {
      setIsMobile(window.innerWidth < 768);
    }
  }, []);

  if (isMobile === null) {
    return null;
  }

  const showThreeNodeSystem = router.pathname !== "/devlog";

  return (
    <>
      {showThreeNodeSystem &&
        (isMobile ? (
          <ThreeNodeSystemMobile />
        ) : (
          <ThreeNodeSystem articlesData={articlesData} />
        ))}
      <Component {...pageProps} />
      <SpeedInsights />
    </>
  );
}

MyApp.getInitialProps = async (appContext: AppContext) => {
  // Get initial props from Next's App component.
  const appProps = await App.getInitialProps(appContext);
  let articlesData: ArticleData[] = [];

  // We can only use Node.js filesystem modules on the server.
  // When navigating on the client, appContext.ctx.req will be undefined.
  if (appContext.ctx.req) {
    const fs = require("fs");
    const path = require("path");

    // Build the path to your articles folder.
    const articlesDir = path.join(process.cwd(), "public", "articles");

    // Read all files in the articles folder and filter for .html files.
    const filenames: string[] = fs.readdirSync(articlesDir).filter((file: string) =>
      file.endsWith(".html")
    );

    // Process each file to extract the required article data.
    articlesData = filenames.map((filename: string) => {
      const filePath = path.join(articlesDir, filename);
      const fileContent: string = fs.readFileSync(filePath, "utf8");

      // Use regular expressions to parse out the needed information.
      // Adjust these regex patterns if your HTML structure changes.
      const titleMatch = fileContent.match(/<div\s+class=["']title["']>\s*(.*?)\s*<\/div>/s);
      const dateMatch = fileContent.match(/<div\s+class=["']date["']>\s*(.*?)\s*<\/div>/s);
      const authorMatch = fileContent.match(
        /<div\s+class=["']submit["']>.*?submitted\s+by\s+([^<]+?)\s*<\/div>/s
      );

      const title = titleMatch ? titleMatch[1].trim() : "Untitled";
      const date = dateMatch ? dateMatch[1].trim() : "";
      const author = authorMatch ? authorMatch[1].trim() : "";
      // Derive the slug from the filename (remove the .html extension)
      const slug = filename.replace(/\.html$/, "");

      return { title, date, author, slug };
    });
  }

  // Return the combined props. On the client, articlesData will be an empty array.
  return { ...appProps, articlesData };
};

export { MyApp };